# Dockerfile.test
FROM python:3.11-slim AS test

ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    POETRY_VIRTUALENVS_CREATE=false

WORKDIR /app

# system deps for psycopg2; adjust as needed
RUN apt-get update && apt-get install -y --no-install-recommends \
    postgresql-client \
    gcc libpq-dev build-essential \
  && rm -rf /var/lib/apt/lists/*

RUN groupadd -g 1001 testgroup \
    && useradd -m -u 1000 -g testgroup testuser

COPY requirements.txt /app/requirements.txt
COPY requirements-dev.txt /app/requirements-dev.txt
RUN pip install --upgrade pip setuptools wheel
RUN pip install --no-cache-dir -r /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements-dev.txt

COPY . /app

# Make CI script executable (if present)
RUN [ -f /app/ci/run-tests.sh ] && chmod +x /app/ci/run-tests.sh || true

RUN chown -R testuser:testgroup /app

USER testuser
# default working directory already set
# default command can be overridden by docker-compose
CMD ["./ci/run-tests.sh"]
